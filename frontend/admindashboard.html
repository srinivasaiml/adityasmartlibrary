
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Smart Library</title>

<!-- Icons and Fonts -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Barcode Scanner Library (QuaggaJS) -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
    :root {
        --primary-color: #008080;
        --primary-light-bg: #e0f2f1;
        --background-color: #F8F9FA;
        --card-bg-color: #FFFFFF;
        --text-dark: #2c3e50;
        --text-secondary: #718096;
        --text-light: #A0AEC0;
        --white-color: #FFFFFF;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --warning-text-color: #212529;
        --success-bg: rgba(40, 167, 69, 0.1);
        --danger-bg: rgba(220, 53, 69, 0.1);
        --warning-bg: rgba(255, 193, 7, 0.15);
        --info-bg: rgba(23, 162, 184, 0.1);
        --info-color: #17a2b8;
        --border-color: #E9ECEF;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        --chart-color-bar-total: #A0AEC0;
        --chart-color-bar-occupied: var(--primary-color);
        --chart-color-bar-reserved: var(--warning-color);
        --doughnut-gd-rooms: var(--primary-color);
        --doughnut-study-carrels: #6f42c1;
        --doughnut-e-resource: #fd7e14;
        --doughnut-reading-room: #20c997;
        --doughnut-other: #6c757d;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(to bottom, var(--primary-light-bg), #ffffff); color: var(--text-dark); font-size: 14px; line-height: 1.6; }
    .admin-container { display: flex; min-height: 100vh; }
    .sidebar { width: 250px; background: linear-gradient(to bottom, var(--primary-light-bg), #ffffff); padding: 20px; position: fixed; height: 100%; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); transition: width 0.3s ease; }
    .sidebar .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; font-size: 1.4em; font-weight: 600; color: var(--text-dark); }
    .sidebar .logo i { color: var(--primary-color); font-size: 1.2em; }
    .sidebar ul { list-style-type: none; flex-grow: 1; }
    .sidebar ul li a { display: flex; align-items: center; padding: 12px 15px; color: var(--text-secondary); text-decoration: none; border-radius: 8px; margin: 4px 0; font-weight: 500; transition: all 0.3s ease; }
    .sidebar ul li a i { margin-right: 12px; width: 20px; text-align: center; font-size: 1.2em; }
    .sidebar ul li a:hover, .sidebar ul li a.active { background-color: var(--primary-color); color: var(--white-color); }
    .main-content {
        flex-grow: 1;
        margin-left: 250px;
        display: flex;
        flex-direction: column;
        transition: margin-left 0.3s ease;
        background: linear-gradient(to bottom, var(--primary-light-bg), #ffffff);
    }
    .top-header { background-color: var(--card-bg-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 999; border-bottom: 1px solid var(--border-color); }
    .top-header .header-left .header-main-title { font-size: 1.6em; font-weight: 600; color: var(--text-dark); }
    .top-header .header-left .header-subtitle { font-size: 0.9em; color: var(--text-secondary); }
    .top-header .header-right { display: flex; align-items: center; gap: 18px; }
    .top-header .header-right .icon-btn { background-color: var(--card-bg-color); color: var(--text-secondary); border: 1px solid var(--border-color); width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
    .top-header .header-right .icon-btn:hover { background-color: var(--primary-light-bg); color: var(--primary-color); }
    .top-header .user-info { display: flex; align-items: center; gap: 12px; margin-left: 10px; }
    .top-header .user-info .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); color: var(--white-color); display: flex; align-items: center; justify-content: center; font-weight: 600; overflow: hidden; }
    .top-header .user-info .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .top-header .user-info .user-details .user-name { font-weight: 600; font-size: 1em; }
    .top-header .user-info .user-details .user-role { font-size: 0.85em; color: var(--text-secondary); }
    .logout-btn { background-color: var(--danger-bg); color: var(--danger-color); border: 1px solid var(--danger-color); font-weight: 500; }
    .logout-btn:hover { background-color: var(--danger-color); color: var(--white-color); }
    .content-area { padding: 30px; flex-grow: 1; }
    .content-section { display: none; }
    .content-section.active { display: block; animation: fadeInSection 0.5s ease-out; }
    @keyframes fadeInSection { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
    .section-header h2 { font-size: 1.6em; font-weight: 600; color: var(--text-dark); margin: 0; padding: 0; border: none; }
    .stats-grid-library { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px; margin-bottom: 30px; }
    .stat-card-library { background-color: var(--card-bg-color); padding: 20px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .stat-card-library:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.07); }
    .stat-card-library .stat-icon-bg { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; flex-shrink: 0; background-color: var(--primary-light-bg); color: var(--primary-color); }
    .stat-card-library .stat-title-library { font-size: 0.9em; color: var(--text-secondary); font-weight: 500; }
    .stat-card-library .stat-value-library { font-size: 2em; font-weight: 600; color: var(--text-dark); line-height: 1.2; }
    .stat-card-library .stat-subtext { font-size: 0.8em; color: var(--text-light); }
    .stat-card-library.primary-card { background-color: var(--primary-color); color: var(--white-color); }
    .stat-card-library.primary-card .stat-icon-bg { background-color: rgba(255, 255, 255, 0.2); }
    .stat-card-library.primary-card .stat-title-library, .stat-card-library.primary-card .stat-value-library, .stat-card-library.primary-card .stat-subtext { color: var(--white-color); opacity: 0.9; }
    .stat-card-library.primary-card .stat-value-library { opacity: 1; }
    .stat-card-library .icon-occupied { color: var(--danger-color); background-color: var(--danger-bg); }
    .stat-card-library .icon-reserved { color: var(--warning-color); background-color: var(--warning-bg); }
    .stat-card-library .icon-available-seats { color: var(--success-color); background-color: var(--success-bg); }
    .stat-card-library .icon-books-checked-out { color: #0BC5EA; background-color: #B2F5EA; }
    .charts-grid-library { display: grid; grid-template-columns: 1fr 1.6fr; gap: 24px; margin-bottom: 30px; align-items: center; }
    .chart-container-library { background-color: var(--card-bg-color); padding: 25px; border-radius: 12px; display: flex; flex-direction: column; height: 420px; }
    .chart-header-custom { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-shrink: 0; }
    .chart-header-custom .chart-title-area h3 { font-size: 1.2em; font-weight: 600; color: var(--text-dark); margin:0; }
    .chart-header-custom .chart-title-area p { font-size: 0.85em; color: var(--text-secondary); margin:0; }
    .chart-container-library .canvas-wrapper { flex-grow: 1; position: relative; min-height: 0; }
    .chart-container-library canvas { max-width: 100%; width: 100% !important; height: 100% !important; }
    .grid { --radius: 42px; --perspective: 800px; --width: 380px; position: absolute; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(5, 1fr); pointer-events: none; }
    .grid .area { position: relative; z-index: 10; pointer-events: auto; }
    .glow,.glow-in1,.glow-in2,.glow-out1,.glow-out2 { position: absolute; overflow: hidden; border-radius: inherit; filter: brightness(1.5); pointer-events: none; }
    .glow::before,.glow-in1::before,.glow-in2::before,.glow-out1::before,.glow-out2::before { transform: translate(-50%, -50%) rotate(45deg); position: absolute; top: 50%; left: 50%; width: 180%; height: 180%; content: ""; transition: transform 1.5s ease; }
    .glow::before { z-index: -2; background: conic-gradient(#b52f2f 0%,transparent 20%,#cf8030 50%,black 60%,transparent 80%,#b52f2f 100%); }
    .glow-in1::before { background: conic-gradient(from 0turn at 50% 30%,#b52f2f 12%,transparent 17%,transparent 90%,#b52f2f 100%); }
    .glow-in2::before { background: conic-gradient(from 0turn at 45% 60%,transparent 30%,#cf8030 55%,transparent 60%); }
    .glow { filter: blur(18px); inset: 5px; opacity: 0.5; z-index: 3; }
    .glow-in1,.glow-in2 { filter: blur(50px); inset: -15px; opacity: 0.5; }
    .glow-in2 { opacity: 0.2; }
    .glow-out1 { inset: -1px; z-index: 1; opacity: 0.5; }
    .glow-out2 { inset: 6px; opacity: 1; transform: translateZ(10px); border-radius: calc(var(--radius) * 0.8); }
    .glow-out1::before,.glow-out2::before { background: conic-gradient(#b52f2f 0%,transparent 10%,transparent 35%,#cf8030 50%,transparent 60%,transparent 90%,#b52f2f 100%); }
    .wrap:hover .glow::before,.wrap:hover .glow-in1::before,.wrap:hover .glow-in2::before,.wrap:hover .glow-out1::before,.wrap:hover .glow-out2::before { transform: translate(-50%, -50%) rotate(410deg); }
    .wrap { display: flex; align-items: center; justify-items: center; position: absolute; left: 50%; top: 50%; transform: translateX(-50%) translateY(-50%); z-index: 9; border-radius: var(--radius); pointer-events: none; }
    .wrap::before { background: rgb(255, 251, 251); position: absolute; content: ""; inset: 8px; filter: blur(5px); border-radius: 50px; }
    .card { padding: 7px 7px 7px 7px; border-radius: inherit; }
    .card,.glare::before { transform-style: preserve-3d; will-change: transform; }
    .wrap:hover .card { transform: perspective(var(--perspective)) rotateX(0) rotateY(0) scale3d(1, 1, 1); }
    .card-bg {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(145deg, #0d1b2a, #005959 90%);
        z-index: 2;
    }
   .card-content {
    box-shadow: inset 0 0 2px rgba(255, 255, 255, 0.1), inset 0 0 70px #2e303c, inset 40px 70px 30px -20px rgba(0, 0, 0, 0.3), inset 0 30px 5px -30px rgba(255, 255, 255, 0.7), inset 0 -3px 2px -2px white;
    background: linear-gradient(165deg, #004d4d, #0d1b2a 85%);
    padding: 25px 28px 5px 28px;
    border-radius: calc(var(--radius) * 0.8);
    transform-style: preserve-3d;
    transform: translateZ(10px);
    position: relative;
    z-index: 3;
}
    .card,.card-content,.glare::before { transition: 2s cubic-bezier(0.03, 1, 0.5, 1); }
    header { line-height: 20px; margin-bottom: 3px; position: relative; transform: translateZ(30px); transform-style: preserve-3d; color: rgba(255, 255, 255, 0.6); transition: all 0.3s ease; }
    header .title { font-size: 12px; }
    header .views { font-size: 20px; font-weight: 700; display: flex; align-items: center; max-width: 50%; }
    header .icon { border-radius: 50%; font-size: 24px; padding: 2px 0 0 0; width: 40px; height: 40px; position: absolute; right: -6px; top: 0px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 1px 2px rgba(250, 187, 15, 0.7), 0 -3px 2px 5px rgba(0, 0, 0, 0.3), 0 0 1px 3px black, 0 3px 3px 2px #ff98a8; transform-style: preserve-3d; transition: all 0.3s ease; }
    header .icon::before,header .icon::after { content: ""; position: absolute; inset: 1px; border-radius: 50%; box-shadow: 0 0 1px 2px #fabb0f; transition: all 0.3s ease; opacity: 0; pointer-events: none; }
    header .icon:hover::before,header .icon:hover::after { animation: ring 1.5s ease infinite; }
    header .icon:hover::after { animation-delay: 750ms; }
    header .icon svg { display: block; animation: heart 1.s linear infinite; pointer-events: none; }
    header .icon:hover svg { animation-duration: 0.8s; }
    header .icon:hover { background-color: #1e191e; }
    footer:hover,header .views:hover .number { color: white; }
    header span[data-label] { position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; z-index: 10; top: 0; }
    header span[data-label]::before,header span[data-label]::after { content: attr(data-label); transition: all 0.2s ease; }
    header span[data-label]::before { left: 0; position: absolute; transform: translateY(-20px); color: white; }
    header .views:hover span[data-label]::before { transform: translateY(0px); }
    header .views:hover span[data-label]::after { transform: translateY(20px); }
    .number { text-align: right; overflow: hidden; display: flex; width: auto; }
    .number::before { position: absolute; bottom: 0; left: 14px; content: ","; display: none; }
    .number.show-comma::before { display: block; }
    .number > div { display: grid; width: 12px; height: 20px; line-height: 20px; margin-right: 1px; text-align: center; transition: transform 1.5s ease; }
    header .views:hover .number > div { transition: none; }
    .chart { width: var(--width); }
    .chart svg { display: block; width: 100%; overflow: visible; }
    .chart svg line { animation: lines 5s ease calc(1s + var(--i) * 0.05s) infinite; opacity: 0; stroke: rgba(255, 255, 255, 0.5); filter: drop-shadow(0 -4px 1px rgba(0, 0, 0, 0.7)); }
    footer { font-size: 10px; font-weight: 500; display: flex; transform: translateZ(30px) translateY(-3px); transition: all 0.3s ease; transform-style: preserve-3d; margin: -10px -10px 0 -10px; }
    footer span { width: 100%; display: block; animation: labels 5s ease calc(1s + var(--i) * 0.1s) infinite; opacity: 0; }
    footer span::before { transition: all 0.2s ease; content: attr(data-label); display: block; text-align: center; font-weight: 600; width: 100%; padding: 15px 0; pointer-events: none; color: rgba(255, 255, 255, 0.6); }
    footer span:hover::before { color: white; transform: translateY(-5px) scale(1.3); text-shadow: 0 7px 3px rgba(0, 0, 0, 0.3); }
    .path1-g { transform: translateY(-3px); }
    .path1, .path2 { stroke-dasharray: 0 510; stroke-dashoffset: 1; animation: path 5s ease infinite 1s; }
    .path1:nth-child(2),.path2:nth-child(2) { transform: translateY(5px); }
    .glare { position: absolute; overflow: hidden; border-radius: inherit; filter: blur(10px); inset: 5px; opacity: 0.5; pointer-events: none; }
    .glare::before { content: ""; position: absolute; top: 50%; left: 50%; background: white; filter: blur(60px); border-radius: 50%; width: 100px; height: 100px; transform: translate(-50%, -50%); opacity: 0; }
    .area:nth-child(1):hover ~ .wrap .glare::before { transform: translate(-200%, -200%); opacity: 0.7; }
    .area:nth-child(2):hover ~ .wrap .glare::before { transform: translate(-120%, -200%) scaleX(1.2); opacity: 0.5; }
    .area:nth-child(3):hover ~ .wrap .glare::before { transform: translate(-50%, -200%) scaleX(1.5); opacity: 0.5; background-color: #ffc2c2; }
    .area:nth-child(4):hover ~ .wrap .glare::before { transform: translate(30%, -200%) scaleX(1.2); opacity: 0.5; background-color: #ff9393; }
    .area:nth-child(5):hover ~ .wrap .glare::before { transform: translate(110%, -200%); opacity: 0.7; background-color: #ff5e5e; }
    .area:nth-child(6):hover ~ .wrap .glare::before { transform: translate(-230%, -50%) scaleY(1.2); opacity: 0.7; background-color: #fffca6; }
    .area:nth-child(7):hover ~ .wrap .glare::before { transform: translate(-200%, -50%); opacity: 0.5; background-color: #fffca6; }
    .area:nth-child(8):hover ~ .wrap .glare::before { filter: blur(100px); }
    .area:nth-child(9):hover ~ .wrap .glare::before { transform: translate(110%, -50%); opacity: 0.5; background-color: #ff9393; }
    .area:nth-child(10):hover ~ .wrap .glare::before { transform: translate(140%, -50%) scaleY(1.2); opacity: 0.7; background-color: #ff9393; }
    .area:nth-child(11):hover ~ .wrap .glare::before { transform: translate(-200%, 100%); opacity: 0.7; background-color: #fffa5e; }
    .area:nth-child(12):hover ~ .wrap .glare::before { transform: translate(-120%, 100%) scaleX(1.2); opacity: 0.5; background-color: #fffca6; }
    .area:nth-child(13):hover ~ .wrap .glare::before { transform: translate(-50%, 100%) scaleX(1.5); opacity: 0.5; background-color: #fffdce; }
    .area:nth-child(14):hover ~ .wrap .glare::before { transform: translate(30%, 100%) scaleX(1.2); opacity: 0.5; }
    .area:nth-child(15):hover ~ .wrap .glare::before { transform: translate(110%, 100%); opacity: 0.7; }
    .area:nth-child(1):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(-15deg) rotateY(15deg) scale3d(1, 1, 1); }
    .area:nth-child(2):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(-15deg) rotateY(7deg) scale3d(1, 1, 1); }
    .area:nth-child(3):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(-15deg) rotateY(0) scale3d(1, 1, 1); }
    .area:nth-child(4):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(-15deg) rotateY(-7deg) scale3d(1, 1, 1); }
    .area:nth-child(5):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(-15deg) rotateY(-15deg) scale3d(1, 1, 1); }
    .area:nth-child(6):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(0) rotateY(15deg) scale3d(1, 1, 1); }
    .area:nth-child(7):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(0) rotateY(7deg) scale3d(1, 1, 1); }
    .area:nth-child(8):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(0) rotateY(0) scale3d(1, 1, 1); }
    .area:nth-child(9):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(0) rotateY(-7deg) scale3d(1, 1, 1); }
    .area:nth-child(10):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(0) rotateY(-15deg) scale3d(1, 1, 1); }
    .area:nth-child(11):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(15deg) rotateY(15deg) scale3d(1, 1, 1); }
    .area:nth-child(12):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(15deg) rotateY(7deg) scale3d(1, 1, 1); }
    .area:nth-child(13):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(15deg) rotateY(0) scale3d(1, 1, 1); }
    .area:nth-child(14):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(15deg) rotateY(-7deg) scale3d(1, 1, 1); }
    .area:nth-child(15):hover ~ .wrap .card { transform: perspective(var(--perspective)) rotateX(15deg) rotateY(-15deg) scale3d(1, 1, 1); }
    @keyframes labels { 0% { transform: translateY(-30px); filter: blur(10px); } 8% { transform: translateY(10px); } 15% { transform: translateY(0); opacity: 1; filter: blur(0); } 80% { transform: translateY(0); opacity: 1; } 85% { filter: blur(0px); transform: translateY(-5px); } 90% { transform: translateY(15px); opacity: 0; filter: blur(10px); } }
    @keyframes lines { 0% { transform: translateY(0); opacity: 0; } 7% { transform: translateY(-20px); } 12% { transform: translateY(10px); } 17% { transform: translateY(-5px); } 25% { transform: translateY(0); opacity: 1; } 80% { transform: translateY(0); opacity: 1; } 85% { transform: translateY(-20px); } 90% { transform: translateY(20px); opacity: 0; } }
    @keyframes heart { 5% { transform: scale(0.8) translateZ(0px); } 20% { transform: scale(1.2) translateZ(40px); } 40% { transform: scale(1) translateZ(20px); } 50% { transform: scale(1.2) translateZ(30px); } 70% { transform: scale(0.8) translateZ(20px); } 100% { transform: scale(1) translateZ(0px); } }
    @keyframes ring { 0% { transform: scale(1); opacity: 0; } 30% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; filter: blur(5px); } }
    @keyframes path { 0% { } 30% { stroke-dasharray: 510 510; } 80% { stroke-dashoffset: 1; stroke-dasharray: 510; } 100% { stroke-dashoffset: 1; stroke-dashoffset: -510; } }
    @keyframes units { to { transform: translateY(calc(-100% * calc(var(--num) + 1))); } }
    
    .table-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .table-section-header h3 { font-size: 1.3em; font-weight: 600; color: var(--text-dark); margin: 0; }
    .table-container { background-color: var(--card-bg-color); padding: 20px; border-radius: 12px; overflow-x: auto; margin-bottom: 30px; }
    table.theme-table, table#book-collection-table, table#main-activity-log-table, table#dashboard-activity-log-table { width: 100%; border-collapse: collapse; }
    .theme-table th, .theme-table td { padding: 14px 15px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.9em; color: var(--text-secondary); vertical-align: middle; }
    .theme-table th { font-weight: 600; color: var(--text-dark); background-color: var(--background-color); text-transform: uppercase; font-size: 0.8em; }
    .theme-table tbody tr:hover { background-color: #f9fafb; }
    .theme-table tbody tr:last-child td { border-bottom: none; }
    .theme-table td .user-name-activity { font-weight: 600; color: var(--text-dark); }
    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; display: inline-block; text-align: center; min-width: 90px; }
    .status-badge.available { background-color: var(--success-bg); color: var(--success-color); }
    .status-badge.checked-out, .status-badge.occupied, .status-badge.in-use { background-color: var(--danger-bg); color: var(--danger-color); }
    .status-badge.reserved, .status-badge.pending-reservation { background-color: var(--warning-bg); color: var(--warning-text-color); }
    .status-badge.maintenance { background-color: var(--text-light); color: var(--white-color); }
    .btn { padding: 10px 18px; border: 1px solid transparent; border-radius: 8px; cursor: pointer; font-size: 0.9em; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; font-weight: 500; transition: all 0.2s ease; }
    .btn i { margin-right: 8px; }
    .btn-primary { background-color: var(--primary-color); color: var(--white-color); }
    .btn-primary:hover { background-color: #005959; }
    .btn-secondary { background-color: var(--primary-light-bg); color: var(--primary-color); }
    .btn-secondary:hover { background-color: #d0e8e7; }
    .btn-sm { padding: 6px 12px; font-size: 0.85em; border-radius: 6px; }
    .btn-edit { background-color: var(--primary-color); color: white; margin-right: 5px; }
    .btn-delete { background-color: var(--danger-color); color: white; }
    .seat-filters .btn-filter { background-color: var(--card-bg-color); color: var(--text-secondary); border: 1px solid var(--border-color); }
    .seat-filters .btn-filter.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    .seat-category { margin-bottom: 30px; }
    .seat-category h3 { font-size: 1.3em; margin-bottom: 15px; color: var(--text-dark); font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
    .seat-grid { display: grid; gap: 15px; }
    .gd-rooms { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .study-carrels, .e-resource, .reading-room { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
    .seat-card, .gd-seat { padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; border: 1px solid; font-weight: 500; }
    .seat-card:hover, .gd-seat:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
    .seat-card i, .gd-seat i { display: block; font-size: 1.8em; margin-bottom: 8px; }
    .seat-card.gd-room { padding: 15px; display: flex; flex-direction: column; background-color: var(--card-bg-color); border: 1px solid var(--border-color); }
    .gd-room .room-title { font-weight: 600; margin-bottom: 10px; font-size: 1em; padding-bottom: 8px; color: var(--text-dark); }
    .gd-sub-seats { display: flex; justify-content: space-around; margin-top: 10px; gap: 8px; }
    .seat-card.available, .gd-seat.available { background-color: var(--success-bg); border-color: var(--success-color); color: var(--success-color); }
    .seat-card.occupied, .gd-seat.occupied, .seat-card.in-use, .gd-seat.in-use { background-color: var(--danger-bg); border-color: var(--danger-color); color: var(--danger-color); }
    .seat-card.pending-reservation, .gd-seat.pending-reservation, .seat-card.reserved, .gd-seat.reserved { background-color: var(--warning-bg); border-color: var(--warning-color); color: var(--warning-text-color); }
    .seat-card.maintenance, .gd-seat.maintenance { background-color: var(--text-light); border-color: var(--text-secondary); color: var(--white-color); }
    .seat-card .timer, .gd-seat .timer, .seat-card .user-on-seat, .gd-seat .user-on-seat { display: block; font-size: 0.8em; margin-top: 5px; font-weight: 500; }
    .seat-card .timer i, .seat-card .user-on-seat i { font-size: 1em; margin-bottom: 0; margin-right: 4px; display: inline; }
    .seat-card.available .timer, .seat-card.available .user-on-seat { display: none; }
    .seat-card.selected-admin, .gd-seat.selected-admin { box-shadow: 0 0 0 3px var(--primary-color) !important; transform: scale(1.03); }
    .seminar-room-grid { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; display: grid;}
    .seminar-room-card { background-color: var(--card-bg-color); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); transition: all 0.2s ease; }
    .seminar-room-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.07); }
    .seminar-room-card h4 { font-size: 1.3em; color: var(--text-dark); font-weight: 600; }
    .seminar-room-card .room-status { font-size: 0.9em; font-weight: 500; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-top: 5px; }
    .seminar-room-card .room-status.available { background-color: var(--success-bg); color: var(--success-color); }
    .seminar-room-card .room-status.reserved { background-color: var(--danger-bg); color: var(--danger-color); }
    .seminar-room-card .reservation-details { margin-top: 15px; font-size: 0.85em; background-color: var(--background-color); padding: 12px; border-radius: 8px; }
    .seminar-room-card .btn-book-seminar { background-color: var(--success-color); color: white; }
    .seminar-room-card .btn-cancel-seminar { background-color: var(--danger-color); color: white; }
    #admin-seat-action-modal, #book-modal, #seminar-booking-modal { display: none; position: fixed; z-index: 1005; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .admin-modal-content { background-color: var(--card-bg-color); padding: 30px; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; animation: zoomInModal 0.3s ease-out; }
    @keyframes zoomInModal { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
    .admin-modal-content h3 { margin-top: 0; color: var(--text-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; font-size: 1.3em; }
    .admin-modal-content label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
    .admin-modal-content input[type="text"], .admin-modal-content input[type="number"], .admin-modal-content input[type="date"], .admin-modal-content select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 1em; background-color: var(--background-color); color: var(--text-dark); }
    .admin-modal-content .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;}
    .admin-modal-content .close-modal-btn { position: absolute; top: 15px; right: 15px; font-size: 1.5em; color: var(--text-light); cursor: pointer; background: none; border: none; }
    #seminar-calculated-duration { font-weight: 600; padding: 10px; background-color: var(--background-color); border-radius: 8px; }
    .time-picker-container { display: flex; gap: 10px; align-items: center; }
    .time-picker-container select { margin-bottom: 0; }
    .time-picker-container select.hour, .time-picker-container select.minute { flex: 2; }
    .time-picker-container select.period { flex: 1; }
    .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { background-color: var(--card-bg-color); padding: 20px; border-radius: 12px; }
    .stat-card h3 { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
    .stat-card .stat-value { font-size: 1.8em; font-weight: 600; color: var(--text-dark); }
    .stat-card .stat-icon { margin-left: 10px; font-size: 0.8em; }
    .stat-card .stat-icon.green { color: var(--success-color); }
    .stat-card .stat-icon.orange { color: var(--warning-color); }
    .stat-card .stat-icon.blue { color: var(--primary-color); }
    
    /* Scanner Page Specific Styles */
    .scanner-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; align-items: flex-start; }
    .scanner-video-container { position: relative; width: 100%; min-height: 400px; background-color: #000; border-radius: 12px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); }
    #scanner-video { width: 100%; height: auto; }
    .scanner-video-container .drawing_buffer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .scanner-placeholder { color: var(--text-light); text-align: center; }
    .scanner-placeholder i { font-size: 5em; margin-bottom: 15px; }
    .scanner-controls { margin-top: 15px; text-align: center; }
    #scan-result-display { padding: 15px; border-radius: 8px; margin-top: 20px; font-weight: 600; text-align: center; transition: all 0.3s ease; }
    #scan-result-display.success { background-color: var(--success-bg); color: var(--success-color); border: 1px solid var(--success-color);}
    #scan-result-display.error { background-color: var(--danger-bg); color: var(--danger-color); border: 1px solid var(--danger-color); }
    #scan-result-display.info { background-color: var(--info-bg); color: var(--info-color); border: 1px solid var(--info-color); }
    .scanner-log-container h3 { font-size: 1.2em; margin-bottom: 10px; color: var(--text-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
    #scanner-log { list-style-type: none; height: 350px; overflow-y: auto; background-color: var(--background-color); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); }
    #scanner-log li { padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
    #scanner-log li:last-child { border-bottom: none; }
    #scanner-log .log-time { font-size: 0.8em; color: var(--text-secondary); }
    #scanner-log .log-msg.success { color: var(--success-color); font-weight: 600; }
    #scanner-log .log-msg.error { color: var(--danger-color); font-weight: 600;}
    #scanner-log .log-msg.info { color: var(--info-color); }

    @media (max-width: 992px) {
        .sidebar { width: 70px; }
        .sidebar .logo span, .sidebar ul li a span { display: none; }
        .sidebar ul li a { justify-content: center; }
        .sidebar ul li a i { margin-right: 0; }
        .main-content { margin-left: 70px; }
        .charts-grid-library { grid-template-columns: 1fr; }
        .chart-container-library, #animated-views-container {
            min-height: 350px;
            height: auto;
        }
        .scanner-layout { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
        body { flex-direction: column; }
        .sidebar {
            width: 100%;
            height: auto;
            position: static;
            flex-direction: row;
            padding: 5px;
            border: none;
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar .logo { display: none; }
        .sidebar ul {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap; 
            justify-content: center; 
            width: 100%;
        }
        .sidebar ul li {
            flex-grow: 1; 
            flex-basis: auto;
            min-width: 80px; 
        }
        .sidebar ul li a {
            flex-direction: column;
            font-size: 0.8em;
            padding: 10px 5px;
        }
        .sidebar ul li a i {
            margin-bottom: 4px;
        }
        .main-content {
            margin-left: 0;
        }
        .top-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        .top-header .header-right {
            width: 100%;
            justify-content: space-between;
        }
        .stats-grid-library {
            grid-template-columns: 1fr 1fr;
        }
        .content-area {
            padding: 15px;
        }
        .study-carrels, .e-resource, .reading-room {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }
        .chart-container-library, #animated-views-container {
            min-height: 320px;
        }
    }

    @media (max-width: 576px) {
            .stats-grid-library {
                grid-template-columns: 1fr;
            }
            .top-header .user-info .user-details {
                display: none;
            }
    }

    @media (max-width: 375px) {
        .sidebar ul li a {
            font-size: 0.7em; 
        }
        .sidebar ul li {
            min-width: 70px;
        }
        .study-carrels, .e-resource, .reading-room {
                grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
        }
    }
</style>
</head>
<body>
<div class="admin-container">
    <nav class="sidebar">
        <div class="logo"><i class="fas fa-university"></i> <span>Smart Library</span></div>
        <ul>
            <li><a href="#" class="nav-link active" data-target="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
            <li><a href="#" class="nav-link" data-target="seats"><i class="fas fa-chair"></i> <span>Seats</span></a></li>
            <li><a href="#" class="nav-link" data-target="seminarseats"><i class="fas fa-chalkboard-teacher"></i> <span>Seminar Rooms</span></a></li>
            <li><a href="#" class="nav-link" data-target="books"><i class="fas fa-book"></i> <span>Books</span></a></li>
            <li><a href="#" class="nav-link" data-target="activities"><i class="fas fa-history"></i> <span>Activities</span></a></li>
            <li><a href="#" class="nav-link" data-target="scanner"><i class="fas fa-user-check"></i> <span>Seat Scanner</span></a></li>
        </ul>
    </nav>
    <main class="main-content">
        <header class="top-header">
            <div class="header-left">
                <h1 class="header-main-title" id="pageTitle">Admin Dashboard</h1>
                <p class="header-subtitle" id="currentDateText">Loading date...</p>
            </div>
            <div class="header-right">
                <span class="icon-btn" title="Search"><i class="fas fa-search"></i></span>
                <span class="icon-btn" title="Notifications"><i class="fas fa-bell"></i></span>
                <div class="user-info">
                    <div class="user-avatar" id="admin-avatar">AD</div>
                    <div class="user-details">
                        <span class="user-name" id="admin-username">Admin</span>
                        <span class="user-role">Administrator</span>
                    </div>
                </div>
                <button class="btn logout-btn" id="admin-logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>
        <div class="content-area">
            <section id="dashboard-content" class="content-section active">
                <div class="stats-grid-library">
                    <div class="stat-card-library primary-card"><div class="card-header"><div class="stat-icon-bg"><i class="fas fa-th-large"></i></div></div><div><h3 class="stat-title-library">Total Seats</h3><p class="stat-value-library" id="db-total-seats">0</p><p class="stat-subtext">Library Capacity</p></div></div>
                    <div class="stat-card-library"><div class="card-header"><div class="stat-icon-bg icon-occupied"><i class="fas fa-users"></i></div></div><div><h3 class="stat-title-library">Occupied Seats</h3><p class="stat-value-library" id="db-occupied-seats">0</p><p class="stat-subtext">Currently In Use</p></div></div>
                    <div class="stat-card-library"><div class="card-header"><div class="stat-icon-bg icon-reserved"><i class="fas fa-user-clock"></i></div></div><div><h3 class="stat-title-library">Reserved Seats</h3><p class="stat-value-library" id="db-reserved-seats">0</p><p class="stat-subtext">Pending User Occupancy</p></div></div>
                    <div class="stat-card-library"><div class="card-header"><div class="stat-icon-bg icon-available-seats"><i class="fas fa-check-circle"></i></div></div><div><h3 class="stat-title-library">Available Seats</h3><p class="stat-value-library" id="db-available-seats">0</p><p class="stat-subtext">Ready for occupancy</p></div></div>
                    <div class="stat-card-library"><div class="card-header"><div class="stat-icon-bg icon-books-checked-out"><i class="fas fa-book-reader"></i></div></div><div><h3 class="stat-title-library">Books Checked Out</h3><p class="stat-value-library" id="db-books-checked-out">0</p><p class="stat-subtext">Currently Loaned</p></div></div>
                </div>
                <div class="charts-grid-library">
                    <div class="chart-container-library">
                        <div class="chart-header-custom">
                            <div class="chart-title-area"><h3>Seat Usage by Category</h3><p>Distribution of occupied & reserved seats</p></div>
                        </div>
                        <div class="canvas-wrapper"><canvas id="seatUsageByCategoryDoughnutChart"></canvas></div>
                    </div>
                    
                    <div class="chart-container-library" id="animated-views-container">
                        <div class="chart-header-custom">
                            <div class="chart-title-area">
                                <h3>Live Occupancy Insights</h3>
                                <p>Real-time seat usage visualization</p>
                            </div>
                        </div>
                        <div class="canvas-wrapper" style="overflow: visible; display: flex; align-items: center; justify-content: center;">
                            <div class="grid">
                                <div class="area"></div><div class="area"></div><div class="area"></div><div class="area"></div><div class="area"></div>
                                <div class="area"></div><div class="area"></div><div class="area"></div><div class="area"></div><div class="area"></div>
                                <div class="area"></div><div class="area"></div><div class="area"></div><div class="area"></div><div class="area"></div>
                                <div class="wrap">
                                    <div class="card">
                                        <div class="glow-out1"></div><div class="glow-out2"></div><div class="glow"></div>
                                        <div class="card-bg"></div>
                                        <div class="card-content">
                                            <div class="glare"></div><div class="glow-in1"></div><div class="glow-in2"></div>
                                            <header>
                                                <div class="views">
                                                    <div class="number" id="animated-chart-number">
                                                    </div>
                                                    <span data-label="seats used"></span>
                                                </div>
                                                <div class="icon">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><defs><linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#ffd867"></stop><stop offset="70%" stop-color="#ec526b"></stop></linearGradient></defs><path fill="url(#gradient)" d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z"></path></svg>
                                                </div>
                                            </header>
                                            <div class="chart">
                                                <svg width="389" height="175" viewBox="0 0 389 200" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="gradientPath1" x1="0%" x2="100%" y1="0%" y2="0%"><stop offset="1%" stop-color="#ffc800"></stop><stop offset="7%" stop-color="#ff694a"></stop><stop offset="40%" stop-color="orange"></stop><stop offset="60%" stop-color="#fa874b"></stop><stop offset="70%" stop-color="#e8a2ab"></stop><stop offset="90%" stop-color="#ff495c"></stop></linearGradient><linearGradient id="gradientPath1b" x1="0%" x2="100%" y1="0%" y2="0%"><stop offset="0%" stop-color="white"></stop><stop offset="10%" stop-color="#fa4b5b"></stop><stop offset="20%" stop-color="white"></stop><stop offset="70%" stop-color="orange"></stop><stop offset="80%" stop-color="#ffe7e1"></stop></linearGradient><linearGradient id="gradientPath2" x2="100%" y1="0%" y2="0%"><stop offset="0%" stop-color="#c78484"></stop><stop offset="50%" stop-color="#ab959b"></stop><stop offset="70%" stop-color="#c78484"></stop><stop offset="80%" stop-color="#e8a2ab"></stop><stop offset="100%" stop-color="#4a3b44"></stop></linearGradient><linearGradient id="gradientPath2b" x2="100%" y1="0%" y2="0%"><stop offset="0%" stop-color="#482948"></stop><stop offset="5%" stop-color="#9f3737"></stop><stop offset="15%" stop-color="#c78484"></stop><stop offset="30%" stop-color="#332a38"></stop><stop offset="50%" stop-color="#332a38"></stop><stop offset="70%" stop-color="#da4847"></stop><stop offset="85%" stop-color="#372c37"></stop><stop offset="100%" stop-color="#442b35"></stop></linearGradient></defs><line style="--i: 1" x1="3" y1="162.5" x2="389" y2="162.5" stroke-opacity="0.9"></line><line style="--i: 2" x1="3" y1="125.5" x2="389" y2="125.5" stroke-opacity="0.8"></line><line style="--i: 3" x1="3" y1="88.5" x2="389" y2="88.5" stroke-opacity="0.7"></line><line style="--i: 4" x1="3" y1="51.5" x2="389" y2="51.5" stroke-opacity="0.6"></line><line style="--i: 5" x1="3" y1="14.5" x2="389" y2="14.5" stroke-opacity="0.5"></line>
                                                    <g filter="url('#goo')" class="path1-g"><path class="path1" d="M5.5 174.5C20.0137 109.586 20 54.9643 49.5 36C79 17.0357 140.5 101 179 93C217.5 85 230.438 40.7006 274.5 36.5C318.562 32.2994 334.5 33 372.5 21" stroke="url(#gradientPath1b)" stroke-width="11" stroke-linecap="round" stroke-linejoin="round"></path><path class="path1" d="M5.5 174.5C20.0137 109.586 20 54.9643 49.5 36C79 17.0357 140.5 101 179 93C217.5 85 230.438 40.7006 274.5 36.5C318.562 32.2994 334.5 33 372.5 21" stroke="url(#gradientPath1)" stroke-width="11" stroke-linecap="round" stroke-linejoin="round"></path></g>
                                                    <g filter="url('#goo')"><path class="path2" stroke="url(#gradientPath2)" d="M21.5 6C57.8366 66.5908 89.5 112.167 124.5 108C159.5 103.833 182.5 49 226 38.5C269.5 28 286.5 52.5 323.5 52.5C331.5 52.5 339 52 350 46.5" stroke-width="11" stroke-linecap="round"></path><path class="path2" stroke="url(#gradientPath2b)" d="M21.5 6C57.8366 66.5908 89.5 112.167 124.5 108C159.5 103.833 182.5 49 226 38.5C269.5 28 286.5 52.5 323.5 52.5C331.5 52.5 339 52 350 46.5" stroke-width="11" stroke-linecap="round"></path></g>
                                                    <filter id="goo"><feGaussianBlur stdDeviation="2" result="blur" in="SourceGraphic"></feGaussianBlur><feColorMatrix result="goo" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" mode="matrix" in="blur"></feColorMatrix></filter></svg>
                                            </div>
                                            <footer>
                                                <span style="--i: 1" data-label="9am"></span>
                                                <span style="--i: 2" data-label="10am"></span>
                                                <span style="--i: 3" data-label="11am"></span>
                                                <span style="--i: 4" data-label="12pm"></span>
                                                <span style="--i: 5" data-label="1pm"></span>
                                                <span style="--i: 6" data-label="2pm"></span>
                                                <span style="--i: 7" data-label="3pm"></span>
                                                <span style="--i: 8" data-label="4pm"></span>
                                            </footer>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-section-header"><h3>Recent Activities</h3><button class="btn btn-sm btn-secondary" id="refresh-activities-btn"><i class="fas fa-sync-alt"></i> Refresh</button></div>
                <div class="table-container"><table class="theme-table" id="dashboard-activity-log-table"><thead><tr><th>TIME</th><th>USER</th><th>ACTION</th><th>RESOURCE</th><th>DETAILS</th></tr></thead><tbody></tbody></table></div>
            </section>
            <section id="seats-content" class="content-section">
                <div class="section-header"><h2>Seats Management</h2><div class="seat-filters"><button class="btn btn-sm btn-filter active" data-filter="all">All</button><button class="btn btn-sm btn-filter" data-filter="gd-rooms">Group Rooms</button><button class="btn btn-sm btn-filter" data-filter="study-carrels">Study Carrels</button><button class="btn btn-sm btn-filter" data-filter="e-resource">E-Resource</button><button class="btn btn-sm btn-filter" data-filter="reading-room">Reading Room</button></div></div>
                <div id="admin-seat-map-area"><p>Loading seat map...</p></div>
            </section>
            <section id="seminarseats-content" class="content-section">
                <div class="section-header"><h2>Seminar Room Management</h2><button class="btn btn-sm btn-secondary" id="refresh-seminar-rooms-btn"><i class="fas fa-sync-alt"></i> Refresh Rooms</button></div>
                <div id="seminar-room-grid-container" class="seminar-room-grid"><p>Loading seminar rooms...</p></div>
            </section>
            <section id="books-content" class="content-section">
                <div class="section-header"><h2>Book Management</h2><button class="btn btn-primary" id="addNewBookBtn"><i class="fas fa-plus"></i> Add New Book</button></div>
                <div class="stats-cards book-stats">
                    <div class="stat-card"><h3>Total Books</h3><p class="stat-value">0 <i class="fas fa-book-open stat-icon blue"></i></p></div>
                    <div class="stat-card"><h3>Available</h3><p class="stat-value">0 <i class="fas fa-check-circle stat-icon green"></i></p></div>
                    <div class="stat-card"><h3>Checked Out</h3><p class="stat-value">0 <i class="fas fa-hourglass-half stat-icon orange"></i></p></div>
                    <div class="stat-card"><h3>Reserved</h3><p class="stat-value">0 <i class="fas fa-user-clock stat-icon blue"></i></p></div>
                </div>
                <div class="table-container"><h3>Book Collection</h3><table class="theme-table" id="book-collection-table"><thead><tr><th>TITLE</th><th>AUTHOR</th><th>STATUS</th><th>RACK</th><th>ISBN</th><th>ACTIONS</th></tr></thead><tbody></tbody></table></div>
            </section>
            <section id="activities-content" class="content-section">
                <div class="section-header"><h2>Activity Logs</h2><button class="btn btn-secondary" id="exportLogsBtn"><i class="fas fa-file-export"></i> Export Logs</button></div>
                 <div class="stats-cards activity-stats">
                    <div class="stat-card"><h3>Total Activities</h3><p class="stat-value" id="totalActivitiesStat">0 <i class="fas fa-wave-square stat-icon blue"></i></p></div>
                    <div class="stat-card"><h3>Book Activities</h3><p class="stat-value" id="bookActivitiesStat">0 <i class="fas fa-book stat-icon green"></i></p></div>
                    <div class="stat-card"><h3>Seat Activities</h3><p class="stat-value" id="seatActivitiesStat">0 <i class="fas fa-chair stat-icon blue"></i></p></div>
                     <div class="stat-card"><h3>Users Active Today</h3><p class="stat-value" id="usersActiveTodayStat">0 <i class="fas fa-users stat-icon orange"></i></p></div>
                </div>
                <div class="table-container"><h3>All Activities</h3><table class="theme-table" id="main-activity-log-table"><thead><tr><th>TIME</th><th>USER</th><th>ACTION</th><th>RESOURCE</th><th>DETAILS</th></tr></thead><tbody></tbody></table></div>
            </section>
            <section id="scanner-content" class="content-section">
                <div class="section-header">
                    <h2>Student Seat Scanner</h2>
                </div>
                <div class="scanner-layout">
                    <div class="scanner-main-panel">
                        <div id="scanner-video-container" class="scanner-video-container">
                            <div class="scanner-placeholder" id="scanner-placeholder-div">
                                <i class="fas fa-barcode"></i>
                                <p>Scan Student ID for Check-in or Check-out.</p>
                            </div>
                            <video id="scanner-video" playsinline style="display:none;"></video>
                        </div>
                        <div id="scan-result-display" style="display:none;"></div>
                        <div class="scanner-controls">
                            <button class="btn btn-primary" id="toggle-scanner-btn"><i class="fas fa-video"></i> Start Camera</button>
                        </div>
                    </div>
                    <div class="scanner-log-container">
                        <h3>Recent Scans (This Session)</h3>
                        <ul id="scanner-log">
                            <li style="text-align: center; color: var(--text-light);">No scans yet.</li>
                        </ul>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<div id="admin-seat-action-modal">
    <div class="admin-modal-content">
        <button class="close-modal-btn" id="close-admin-modal-btn"></button>
        <h3 id="admin-modal-title">Seat Action</h3><input type="hidden" id="admin-modal-seat-id">
        <div><label for="admin-seat-status">Change Status To:</label><select id="admin-seat-status"><option value="available">Available</option><option value="occupied">Occupied</option><option value="maintenance">Maintenance</option></select></div>
        <div id="admin-occupied-by-container" style="display:none;"><label for="admin-occupied-by-username">Occupied by Student ID (optional):</label><input type="text" id="admin-occupied-by-username" placeholder="Enter student ID"></div>
        <div class="modal-actions"><button class="btn btn-secondary" id="cancel-admin-seat-action-btn">Cancel</button><button class="btn btn-primary" id="confirm-admin-seat-action-btn">Confirm</button></div>
    </div>
</div>
<div id="book-modal" style="display: none;">
    <div class="admin-modal-content">
        <button class="close-modal-btn" id="close-book-modal-btn"></button>
        <h3 id="book-modal-title">Add New Book</h3><input type="hidden" id="book-modal-id">
        <div><label for="book-title">Title:</label><input type="text" id="book-title" required></div>
        <div><label for="book-author">Author:</label><input type="text" id="book-author" required></div>
        <div><label for="book-isbn">ISBN (optional):</label><input type="text" id="book-isbn"></div>
        <div><label for="book-status">Status:</label><select id="book-status"><option value="available">Available</option><option value="checked-out">Checked Out</option><option value="reserved">Reserved</option><option value="maintenance">Maintenance</option></select></div>
        <div><label for="book-rack">Rack Location:</label><input type="text" id="book-rack" required></div>
        <div id="book-quantity-container"><label for="book-quantity">Quantity (for new books):</label><input type="number" id="book-quantity" min="1" value="1"></div>
        <div class="modal-actions"><button class="btn btn-secondary" id="cancel-book-action-btn">Cancel</button><button class="btn btn-primary" id="confirm-book-action-btn">Save Book</button></div>
    </div>
</div>
<div id="seminar-booking-modal" style="display: none;">
    <div class="admin-modal-content">
        <button class="close-modal-btn" id="close-seminar-booking-modal-btn"></button>
        <h3 id="seminar-booking-modal-title">Book Seminar Room</h3>
        <input type="hidden" id="seminar-booking-room-id">
        <input type="hidden" id="seminar-booking-room-name">
        <div><label for="seminar-workshop-name">Purpose:</label><input type="text" id="seminar-workshop-name" required></div>
        
        <div>
            <label for="seminar-start-date">Start Date:</label>
            <input type="date" id="seminar-start-date" required>
        </div>
        <div style="margin-top: 15px;">
            <label for="seminar-end-date">End Date:</label>
            <input type="date" id="seminar-end-date" required>
        </div>

        <div style="margin-top: 15px;">
            <label for="seminar-start-hour">Start Time:</label>
            <div class="time-picker-container">
                <select id="seminar-start-hour" class="hour" required></select>
                <select id="seminar-start-minute" class="minute" required>
                    <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                </select>
                <select id="seminar-start-period" class="period" required>
                    <option>AM</option><option>PM</option>
                </select>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <label for="seminar-end-hour">End Time:</label>
            <div class="time-picker-container">
                 <select id="seminar-end-hour" class="hour" required></select>
                <select id="seminar-end-minute" class="minute" required>
                    <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                </select>
                <select id="seminar-end-period" class="period" required>
                    <option>AM</option><option>PM</option>
                </select>
            </div>
        </div>
        <div style="margin-top: 15px;"><label>Calculated Duration:</label><p id="seminar-calculated-duration">-</p></div>
        <div>
            <label for="seminar-department-name">Booked by Department:</label>
            <select id="seminar-department-name" required>
                <option value="">-- Select Department --</option>
                <option value="AIML">Artificial Intellegence...</option>
                <option value="Information Technology">Information Technology</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Mechanical Engineering">Mechanical Engineering</option>
                <option value="Civil Engineering">Civil Engineering</option>
                <option value="Electrical & Electronics">Electrical & Electronics</option>
                <option value="Human Resources">Data Science</option>
                <option value="Administration">Administration</option>
                <option value="Library Staff">Library Staff</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancel-seminar-booking-btn">Cancel</button>
            <button class="btn btn-primary" id="confirm-seminar-booking-btn">Confirm Booking</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
const API_BASE_URL = 'http://localhost:5001/api';
const authTokenForAPI = localStorage.getItem('token');
const adminUserString = localStorage.getItem('user');
let adminUser;

if (!authTokenForAPI || !adminUserString) {
    adminUser = { name: 'Srikanth', username: 'srikanth_6158', role: 'admin' };
    localStorage.setItem('user', JSON.stringify(adminUser));
    alert('Demonstration Mode: Using mock user "Srikanth". Login is not required.');
} else {
    try { adminUser = JSON.parse(adminUserString); }
    catch (e) { alert('Invalid user data. Please login again.'); window.location.href = 'login.html'; return; }
}

if (adminUser.role !== 'admin') {
    alert('Access Denied. This page is for Administrators only.');
    localStorage.clear();
    window.location.href = 'login.html'; return;
}

document.getElementById('admin-username').textContent = adminUser.name || adminUser.username;
document.getElementById('admin-avatar').textContent = (adminUser.name || adminUser.username).substring(0, 2).toUpperCase();

// --- ALL ELEMENT SELECTORS ---
const navLinks = document.querySelectorAll('.sidebar .nav-link');
const contentSections = document.querySelectorAll('.content-section');
const pageTitleEl = document.getElementById('pageTitle');
const currentDateEl = document.getElementById('currentDateText');
const dbTotalSeatsEl = document.getElementById('db-total-seats');
const dbOccupiedSeatsEl = document.getElementById('db-occupied-seats');
const dbReservedSeatsEl = document.getElementById('db-reserved-seats');
const dbAvailableSeatsEl = document.getElementById('db-available-seats');
const dbBooksCheckedOutEl = document.getElementById('db-books-checked-out');
const dashboardActivityLogTableBody = document.querySelector('#dashboard-activity-log-table tbody');
const mainActivityLogTableBody = document.querySelector('#main-activity-log-table tbody');
const adminSeatMapArea = document.getElementById('admin-seat-map-area');
const seatFilterButtons = document.querySelectorAll('#seats-content .seat-filters .btn-filter');
const adminSeatActionModal = document.getElementById('admin-seat-action-modal');
const adminModalTitle = document.getElementById('admin-modal-title');
const adminModalSeatIdInput = document.getElementById('admin-modal-seat-id');
const adminSeatStatusSelect = document.getElementById('admin-seat-status');
const adminOccupiedByContainer = document.getElementById('admin-occupied-by-container');
const adminOccupiedByUsernameInput = document.getElementById('admin-occupied-by-username');
const confirmAdminSeatActionBtn = document.getElementById('confirm-admin-seat-action-btn');
const cancelAdminSeatActionBtn = document.getElementById('cancel-admin-seat-action-btn');
const closeModalBtn = document.getElementById('close-admin-modal-btn');
const bookModal = document.getElementById('book-modal');
const bookModalTitle = document.getElementById('book-modal-title');
const bookModalIdInput = document.getElementById('book-modal-id');
const bookTitleInput = document.getElementById('book-title');
const bookAuthorInput = document.getElementById('book-author');
const bookIsbnInput = document.getElementById('book-isbn');
const bookStatusSelect = document.getElementById('book-status');
const bookRackInput = document.getElementById('book-rack');
const bookQuantityContainer = document.getElementById('book-quantity-container');
const bookQuantityInput = document.getElementById('book-quantity');
const confirmBookActionBtn = document.getElementById('confirm-book-action-btn');
const cancelBookActionBtn = document.getElementById('cancel-book-action-btn');
const closeBookModalBtn = document.getElementById('close-book-modal-btn');
const addNewBookBtn = document.getElementById('addNewBookBtn');
const bookCollectionTableBody = document.querySelector('#book-collection-table tbody');
const seminarRoomGridContainer = document.getElementById('seminar-room-grid-container');
const seminarBookingModal = document.getElementById('seminar-booking-modal');
const closeSeminarBookingModalBtn = document.getElementById('close-seminar-booking-modal-btn');
const seminarBookingModalTitle = document.getElementById('seminar-booking-modal-title');
const seminarBookingRoomIdInput = document.getElementById('seminar-booking-room-id');
const seminarBookingRoomNameInput = document.getElementById('seminar-booking-room-name');
const seminarWorkshopNameInput = document.getElementById('seminar-workshop-name');
const seminarStartDateInput = document.getElementById('seminar-start-date');
const seminarEndDateInput = document.getElementById('seminar-end-date');
const seminarStartHourSelect = document.getElementById('seminar-start-hour');
const seminarStartMinuteSelect = document.getElementById('seminar-start-minute');
const seminarStartPeriodSelect = document.getElementById('seminar-start-period');
const seminarEndHourSelect = document.getElementById('seminar-end-hour');
const seminarEndMinuteSelect = document.getElementById('seminar-end-minute');
const seminarEndPeriodSelect = document.getElementById('seminar-end-period');
const seminarCalculatedDurationEl = document.getElementById('seminar-calculated-duration');
const seminarDepartmentNameInput = document.getElementById('seminar-department-name');
const cancelSeminarBookingBtn = document.getElementById('cancel-seminar-booking-btn');
const confirmSeminarBookingBtn = document.getElementById('confirm-seminar-booking-btn');
const refreshSeminarRoomsBtn = document.getElementById('refresh-seminar-rooms-btn');

// --- Scanner Page Elements ---
const scannerVideoContainer = document.getElementById('scanner-video-container');
const scannerVideo = document.getElementById('scanner-video');
const scannerPlaceholder = document.getElementById('scanner-placeholder-div');
const toggleScannerBtn = document.getElementById('toggle-scanner-btn');
const scanResultDisplay = document.getElementById('scan-result-display');
const scannerLog = document.getElementById('scanner-log');

let seatUsageDoughnutChartInstance = null;
let allSeatsDataGlobal = [];
let isScannerActive = false;

// --- START: LocalStorage based state management for seminar rooms ---
const SEMINAR_ROOMS_STORAGE_KEY = 'smartLibrarySeminarRooms';

function getInitialSeminarRooms() {
    const storedRooms = localStorage.getItem(SEMINAR_ROOMS_STORAGE_KEY);
    if (storedRooms) {
        return JSON.parse(storedRooms);
    } else {
        const defaultRooms = [
            { roomId: "SR1", name: "Seminar Room 1", status: "available", icon: "fa-chalkboard" },
            { roomId: "SR2", name: "Conference Hall A", status: "available", icon: "fa-chalkboard" },
            { roomId: "SR3", name: "Training Room B", status: "available", icon: "fa-chalkboard" }
        ];
        localStorage.setItem(SEMINAR_ROOMS_STORAGE_KEY, JSON.stringify(defaultRooms));
        return defaultRooms;
    }
}

let allSeminarRoomsData = getInitialSeminarRooms();

function saveSeminarRoomsToStorage() {
    localStorage.setItem(SEMINAR_ROOMS_STORAGE_KEY, JSON.stringify(allSeminarRoomsData));
}
// --- END: LocalStorage based state management ---

// --- HYBRID fetchData ---
async function fetchData(url, errorMessage = "Failed to fetch data", options = {}) {
    if (url.includes('/seminar-rooms')) {
        console.log(`Intercepted for MOCK (localStorage): ${url}`);
        if (options.method === 'POST' && url.includes('/reserve')) {
            const bookingData = options.body;
            const roomToBook = allSeminarRoomsData.find(r => r.roomId === bookingData.roomId);
            if (roomToBook) {
                roomToBook.status = 'reserved';
                roomToBook.reservationDetails = bookingData;
                saveSeminarRoomsToStorage();
            }
            return Promise.resolve({ success: true });
        }
        if (options.method === 'POST' && url.includes('/cancel')) {
            const roomIdToCancel = url.split('/')[url.split('/').length - 2];
            const roomToCancel = allSeminarRoomsData.find(r => r.roomId === roomIdToCancel);
            if(roomToCancel) {
                roomToCancel.status = 'available';
                delete roomToCancel.reservationDetails;
                saveSeminarRoomsToStorage();
            }
            return Promise.resolve({ success: true });
        }
        return Promise.resolve(allSeminarRoomsData);
    }

    // --- REAL FETCH LOGIC FOR ALL OTHER ROUTES ---
    try {
        const currentAuthToken = localStorage.getItem('token');
        if (!currentAuthToken) { console.error("No auth token for API call:", url); logoutAdmin(); return null; }
        const fetchOptions = { ...options, headers: { ...options.headers, 'Authorization': `Bearer ${currentAuthToken}`}};
        if (fetchOptions.body && typeof fetchOptions.body === 'object' && !(fetchOptions.body instanceof FormData)) {
            if(!fetchOptions.headers['Content-Type']) fetchOptions.headers['Content-Type'] = 'application/json';
            if(fetchOptions.headers['Content-Type'] === 'application/json') fetchOptions.body = JSON.stringify(fetchOptions.body);
        }
        const response = await fetch(url, fetchOptions);
        if (!response.ok) {
            if (response.status === 401) { logoutAdmin("Session expired or invalid. Please log in again."); return null; }
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(`${errorMessage}: ${errorData.message || response.statusText}`);
        }
        if (response.status === 204) return { message: "Success (No Content)"};
        return await response.json();
    } catch (error) { console.error("FetchData Error:", error.message, "URL:", url); alert(error.message); return null; }
}

function getCssVariableValue(varName, fallback = '#000000') { return getComputedStyle(document.documentElement).getPropertyValue(varName).trim() || fallback; }
function updateCurrentDate() { if (currentDateEl) currentDateEl.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
function setPageTitle(title) { if (pageTitleEl) pageTitleEl.textContent = title; document.title = title + " - Smart Library Admin"; }
updateCurrentDate();

const todayForMinDate = new Date().toISOString().split("T")[0];
if(seminarStartDateInput) seminarStartDateInput.min = todayForMinDate;
if(seminarEndDateInput) seminarEndDateInput.min = todayForMinDate;


function populateHourSelects() {
    for (let i = 1; i <= 12; i++) {
        const option1 = document.createElement('option');
        option1.value = i;
        option1.textContent = i;
        seminarStartHourSelect.appendChild(option1);
        const option2 = document.createElement('option');
        option2.value = i;
        option2.textContent = i;
        seminarEndHourSelect.appendChild(option2);
    }
}
populateHourSelects();

navLinks.forEach(link => {
    link.addEventListener('click', function (e) {
        e.preventDefault();
        // If scanner is active and we're navigating away, stop it.
        if (isScannerActive && this.getAttribute('data-target') !== 'scanner') {
            stopBarcodeScanner();
        }

        const targetId = this.getAttribute('data-target');
        navLinks.forEach(nav => nav.classList.remove('active')); this.classList.add('active');
        contentSections.forEach(section => section.classList.remove('active'));
        const targetSection = document.getElementById(targetId + '-content');
        if (targetSection) {
            targetSection.classList.add('active');
            let title = this.querySelector('span').textContent.trim();
            if (targetId === 'dashboard') title = "Admin Dashboard";
            else if (targetId === 'seminarseats') title = "Seminar Rooms";
            else if (targetId === 'scanner') title = "Seat Scanner";
            setPageTitle(title);
            
            if (targetId === 'dashboard') loadDashboardData();
            else if (targetId === 'seats') fetchAndRenderAdminSeats('all');
            else if (targetId === 'seminarseats') loadAndRenderSeminarRooms();
            else if (targetId === 'books') fetchAndRenderBooks();
            else if (targetId === 'activities') fetchAllActivities();
            else if (targetId === 'scanner') setupScannerPage();
        }
    });
});
setPageTitle(document.querySelector('.sidebar .nav-link.active span').textContent || "Admin Dashboard");

function createAdminSeatElement(seat, isGdSubSeat) {
    const el = document.createElement('div');
    el.classList.add(isGdSubSeat ? 'gd-seat' : 'seat-card', seat.status);
    el.dataset.seatId = seat.seatId;
    el.dataset.backendId = seat._id;
    let seatDisplayName = seat.name;
    if (isGdSubSeat && seat.name.includes(" - ")) {
        seatDisplayName = seat.name.split(" - ")[1] || seat.name;
    }
    el.innerHTML = `<i class="fas ${seat.icon || 'fa-chair'}"></i> ${seatDisplayName}`;
    if (seat.status === 'pending-reservation' && seat.reservationEndTime) {
        const timeLeft = new Date(seat.reservationEndTime).getTime() - Date.now();
        if (timeLeft > 0) {
            const mins = Math.floor((timeLeft / 1000 / 60) % 60);
            const secs = Math.floor((timeLeft / 1000) % 60);
            el.innerHTML += `<span class="timer"><i class="fas fa-hourglass-half"></i> ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}</span>`;
        }
    }
    if ((seat.status === 'occupied' || seat.status === 'in-use') && seat.occupiedByUsername) {
        el.innerHTML += `<span class="user-on-seat"><i class="fas fa-user"></i> ${seat.occupiedByUsername}</span>`;
    } else if (seat.status === 'pending-reservation' && seat.reservedBy?.username) {
        el.innerHTML += `<span class="user-on-seat"><i class="fas fa-user-clock"></i> ${seat.reservedBy.username}</span>`;
    }
    el.addEventListener('click', () => openAdminSeatActionModal(seat));
    return el;
}

// --- SEMINAR ROOMS FUNCTIONS ---
async function loadAndRenderSeminarRooms() {
    if (!seminarRoomGridContainer) return;
    seminarRoomGridContainer.innerHTML = '<p>Loading seminar rooms...</p>';
    const rooms = await fetchData(`${API_BASE_URL}/seminar-rooms`, "Failed to load seminar rooms");
    if (rooms && Array.isArray(rooms)) {
        allSeminarRoomsData = rooms; // Ensure our global variable is up-to-date
        renderSeminarRooms(rooms);
    } else {
        seminarRoomGridContainer.innerHTML = '<p>No seminar rooms found.</p>';
    }
}

function renderSeminarRooms(rooms) {
    seminarRoomGridContainer.innerHTML = '';
    if (rooms.length === 0) {
        seminarRoomGridContainer.innerHTML = '<p>No seminar rooms found.</p>';
        return;
    }
    rooms.forEach(room => {
        const card = document.createElement('div');
        card.className = 'seminar-room-card';
        card.dataset.roomId = room.roomId;
        let detailsHTML = '';
        let actionButtonHTML = '';
        if (room.status === 'reserved' && room.reservationDetails) {
            const res = room.reservationDetails;
            const duration = calculateDuration(res.startTime, res.endTime);
            let dateText;
            if (res.startDate && res.endDate) {
                const startLocaleDate = new Date(res.startDate + 'T00:00:00');
                const endLocaleDate = new Date(res.endDate + 'T00:00:00');
                if (res.startDate === res.endDate) {
                    dateText = startLocaleDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                } else {
                    const f_start = startLocaleDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
                    const f_end = endLocaleDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                    dateText = `${f_start} to ${f_end}`;
                }
            } else if (res.date) {
                dateText = new Date(res.date + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            } else {
                dateText = 'N/A';
            }
            detailsHTML = `
                <div class="reservation-details">
                    <p><strong>Workshop:</strong> ${res.workshopName}</p>
                    <p><strong>Department:</strong> ${res.departmentName}</p>
                    <p><strong>Date:</strong> ${dateText}</p>
                    <p><strong>Time:</strong> ${formatTime(res.startTime)} - ${formatTime(res.endTime)} (${duration})</p>
                    <p><strong>Booked By:</strong> ${res.bookedBy}</p>
                </div>`;
            actionButtonHTML = `<button class="btn btn-sm btn-cancel-seminar" data-room-id="${room.roomId}"><i class="fas fa-times-circle"></i> Cancel Reservation</button>`;
        } else {
            detailsHTML = `<p style="color: var(--text-light); font-style: italic;">This room is currently available for booking.</p>`;
            actionButtonHTML = `<button class="btn btn-sm btn-book-seminar" data-room-id="${room.roomId}" data-room-name="${room.name}"><i class="fas fa-calendar-plus"></i> Book Seminar Room</button>`;
        }
        card.innerHTML = `
            <div class="room-header"><i class="fas ${room.icon || 'fa-chalkboard-teacher'} room-icon"></i>
                <div><h4>${room.name}</h4><span class="room-status ${room.status}">${room.status.charAt(0).toUpperCase() + room.status.slice(1)}</span></div>
            </div>
            ${detailsHTML}${actionButtonHTML}`;
        seminarRoomGridContainer.appendChild(card);
    });
    seminarRoomGridContainer.querySelectorAll('.btn-book-seminar').forEach(btn => {
        btn.addEventListener('click', () => {
            const room = allSeminarRoomsData.find(r => r.roomId === btn.dataset.roomId);
            if (room) openSeminarBookingModal(room);
        });
    });
    seminarRoomGridContainer.querySelectorAll('.btn-cancel-seminar').forEach(btn => {
        btn.addEventListener('click', () => handleCancelSeminarReservation(btn.dataset.roomId));
    });
}
if(refreshSeminarRoomsBtn) refreshSeminarRoomsBtn.addEventListener('click', loadAndRenderSeminarRooms);

function openSeminarBookingModal(room) {
    seminarBookingModalTitle.textContent = `Book: ${room.name}`;
    seminarBookingRoomIdInput.value = room.roomId;
    seminarBookingRoomNameInput.value = room.name;
    seminarWorkshopNameInput.value = '';
    const today = new Date().toISOString().split("T")[0];
    seminarStartDateInput.value = today;
    seminarEndDateInput.value = today;
    seminarEndDateInput.min = today;
    seminarStartHourSelect.value = "9"; seminarStartMinuteSelect.value = "00"; seminarStartPeriodSelect.value = "AM";
    seminarEndHourSelect.value = "10"; seminarEndMinuteSelect.value = "00"; seminarEndPeriodSelect.value = "AM";
    seminarDepartmentNameInput.value = '';
    updateFullDurationDisplay();
    seminarBookingModal.style.display = 'flex';
}

function closeSeminarBookingModal() { seminarBookingModal.style.display = 'none'; }
if(closeSeminarBookingModalBtn) closeSeminarBookingModalBtn.addEventListener('click', closeSeminarBookingModal);
if(cancelSeminarBookingBtn) cancelSeminarBookingBtn.addEventListener('click', closeSeminarBookingModal);

function get24HourTime(hourEl, minuteEl, periodEl) { let hour = parseInt(hourEl.value, 10); const minute = minuteEl.value; const period = periodEl.value; if (period === 'PM' && hour < 12) { hour += 12; } if (period === 'AM' && hour === 12) { hour = 0; } return `${String(hour).padStart(2, '0')}:${minute}`; }
function updateFullDurationDisplay() {
    if (!seminarStartDateInput || !seminarEndDateInput) return;
    const timeDuration = calculateDuration(get24HourTime(seminarStartHourSelect, seminarStartMinuteSelect, seminarStartPeriodSelect), get24HourTime(seminarEndHourSelect, seminarEndMinuteSelect, seminarEndPeriodSelect));
    const startDateVal = seminarStartDateInput.value;
    const endDateVal = seminarEndDateInput.value;
    if (!startDateVal || !endDateVal || new Date(endDateVal) < new Date(startDateVal) || timeDuration === "Invalid times") {
        seminarCalculatedDurationEl.textContent = "Invalid date or time range";
        return;
    }
    const start = new Date(startDateVal);
    const end = new Date(endDateVal);
    const dayDiff = Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)) + 1;
    const dayText = dayDiff === 1 ? "1 day" : `${dayDiff} days`;
    seminarCalculatedDurationEl.textContent = `${dayText} (${timeDuration} each day)`;
}
seminarStartDateInput?.addEventListener('change', () => {
    if(seminarEndDateInput) { seminarEndDateInput.min = seminarStartDateInput.value; if (seminarEndDateInput.value < seminarStartDateInput.value) { seminarEndDateInput.value = seminarStartDateInput.value; } }
    updateFullDurationDisplay();
});
seminarEndDateInput?.addEventListener('change', updateFullDurationDisplay);
[seminarStartHourSelect, seminarStartMinuteSelect, seminarStartPeriodSelect, seminarEndHourSelect, seminarEndMinuteSelect, seminarEndPeriodSelect].forEach(el => { el?.addEventListener('change', updateFullDurationDisplay); });

function calculateDuration(startTime, endTime) { const start = new Date(`1970-01-01T${startTime}:00`); const end = new Date(`1970-01-01T${endTime}:00`); if (end <= start) return "Invalid times"; let diff = end.getTime() - start.getTime(); const hours = Math.floor(diff / (1000 * 60 * 60)); diff -= hours * (1000 * 60 * 60); const minutes = Math.floor(diff / (1000 * 60)); return `${hours}h ${minutes}m`; }
function formatTime(timeString) { if (!timeString) return ''; const [hours, minutes] = timeString.split(':'); const h = parseInt(hours, 10); const suffix = h >= 12 ? 'PM' : 'AM'; const H = h % 12 || 12; return `${H}:${minutes} ${suffix}`; }

if(confirmSeminarBookingBtn) confirmSeminarBookingBtn.addEventListener('click', async () => {
    const roomId = seminarBookingRoomIdInput.value;
    const roomName = seminarBookingRoomNameInput.value;
    const workshopName = seminarWorkshopNameInput.value.trim();
    const departmentName = seminarDepartmentNameInput.value; 
    const startDate = seminarStartDateInput.value;
    const endDate = seminarEndDateInput.value;
    const startTime = get24HourTime(seminarStartHourSelect, seminarStartMinuteSelect, seminarStartPeriodSelect);
    const endTime = get24HourTime(seminarEndHourSelect, seminarEndMinuteSelect, seminarEndPeriodSelect);

    if (!workshopName || !startDate || !endDate || !departmentName) { alert("Please fill all required fields, including selecting a department."); return; }
    if (new Date(endDate) < new Date(startDate)) { alert("End date cannot be before start date."); return; }
    if (calculateDuration(startTime, endTime) === 'Invalid times') { alert("End time must be after start time."); return; }

    const bookingData = { 
        roomId, 
        workshopName, 
        startDate, 
        endDate, 
        startTime, 
        endTime, 
        departmentName,
        bookedBy: adminUser.name || adminUser.username
    };

    confirmSeminarBookingBtn.disabled = true; confirmSeminarBookingBtn.textContent = "Booking...";
    const result = await fetchData(`${API_BASE_URL}/seminar-rooms/${roomId}/reserve`, 'Failed to book room', { method: 'POST', body: bookingData });
    if (result && result.success) {
        alert(`${roomName} booked successfully!`);
        closeSeminarBookingModal();
        await loadAndRenderSeminarRooms();
    }
    confirmSeminarBookingBtn.disabled = false; confirmSeminarBookingBtn.textContent = "Confirm Booking";
});

async function handleCancelSeminarReservation(roomId) {
    const roomToCancel = allSeminarRoomsData.find(r => r.roomId === roomId);
    if (!roomToCancel || !roomToCancel.reservationDetails) { alert("Room not found or no active reservation."); return; }
    if (!confirm(`Are you sure you want to cancel the reservation for "${roomToCancel.name}" (Workshop: "${roomToCancel.reservationDetails.workshopName}")?`)) return;
    const result = await fetchData(`${API_BASE_URL}/seminar-rooms/${roomId}/cancel`, `Failed to cancel reservation for ${roomToCancel.name}`, { method: 'POST' });
    if (result && result.success) {
        alert(`Reservation for ${roomToCancel.name} cancelled successfully!`);
        await loadAndRenderSeminarRooms();
    }
}
// --- END OF SEMINAR ROOMS FUNCTIONS ---

async function loadDashboardData() {
    console.log("Loading dashboard data...");
    const seatsPromise = fetchData(`${API_BASE_URL}/seats`, "Failed to load seat data for dashboard");
    const activitiesPromise = fetchData(`${API_BASE_URL}/activities?limit=5`, "Failed to load recent activities for dashboard");
    const booksPromise = fetchData(`${API_BASE_URL}/books`, "Failed to load book data for dashboard stats");
    const [seats, activitiesResponse, books] = await Promise.all([seatsPromise, activitiesPromise, booksPromise]);
    if (seats) {
        allSeatsDataGlobal = seats;
        updateAdminDashboardStats(seats);
        initializeSeatUsageDoughnutChart(seats);
        updateAnimatedChartNumber(seats);
    } else {
        initializeSeatUsageDoughnutChart([]);
    }
    if (activitiesResponse && activitiesResponse.activities) {
        populateActivityTable(dashboardActivityLogTableBody, activitiesResponse.activities);
    } else if(activitiesResponse && Array.isArray(activitiesResponse)) {
        populateActivityTable(dashboardActivityLogTableBody, activitiesResponse);
    }
    if (books) {
        updateBookStats(books);
    } else {
        updateBookStats([]);
    }
}

function animateValue(element, start, end, duration) { if (!element) return; let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); element.textContent = Math.floor(progress * (end - start) + start).toLocaleString(); if (progress < 1) { window.requestAnimationFrame(step); } }; window.requestAnimationFrame(step); }

function updateAdminDashboardStats(seats) {
    const totalSeats = seats?.length || 0;
    const occupiedSeatsCount = seats?.filter(s => s.status === 'occupied' || s.status === 'in-use').length || 0;
    const reservedSeatsCount = seats?.filter(s => s.status === 'pending-reservation').length || 0;
    const availableSeatsCount = seats?.filter(s => s.status === 'available').length || 0;
    if (dbTotalSeatsEl) animateValue(dbTotalSeatsEl, parseInt(dbTotalSeatsEl.textContent.replace(/,/g, '')) || 0, totalSeats, 800);
    if (dbOccupiedSeatsEl) animateValue(dbOccupiedSeatsEl, parseInt(dbOccupiedSeatsEl.textContent.replace(/,/g, '')) || 0, occupiedSeatsCount, 800);
    if (dbReservedSeatsEl) animateValue(dbReservedSeatsEl, parseInt(dbReservedSeatsEl.textContent.replace(/,/g, '')) || 0, reservedSeatsCount, 800);
    if (dbAvailableSeatsEl) animateValue(dbAvailableSeatsEl, parseInt(dbAvailableSeatsEl.textContent.replace(/,/g, '')) || 0, availableSeatsCount, 800);
}

function initializeSeatUsageDoughnutChart(seatsData) { const ctx = document.getElementById('seatUsageByCategoryDoughnutChart')?.getContext('2d'); if (!ctx) { console.error("Canvas for Seat Usage Doughnut Chart not found!"); return; } if (seatUsageDoughnutChartInstance) { seatUsageDoughnutChartInstance.destroy(); } if (!seatsData || seatsData.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.textAlign = 'center'; ctx.font = '14px Poppins'; ctx.fillStyle = getCssVariableValue('--text-secondary'); ctx.fillText('No seat data to display.', ctx.canvas.width / 2, ctx.canvas.height / 2); return; } const categoryCounts = {}; seatsData.forEach(seat => { if (seat.status === 'occupied' || seat.status === 'in-use' || seat.status === 'pending-reservation') { let catName = seat.category.replace(/-/g, ' ').split(' ').map(w => w[0].toUpperCase() + w.slice(1)).join(' '); if (catName === "Gd Rooms") catName = "Group Rooms"; else if (catName === "EResource") catName = "E-Resource"; categoryCounts[catName] = (categoryCounts[catName] || 0) + 1; } }); const categoryOrder = ['Group Rooms', 'Study Carrels', 'E-Resource', 'Reading Room']; const sortedLabels = categoryOrder.filter(label => categoryCounts[label] > 0); Object.keys(categoryCounts).forEach(cat => { if (!sortedLabels.includes(cat) && categoryCounts[cat] > 0) { sortedLabels.push(cat); } }); const sortedData = sortedLabels.map(label => categoryCounts[label]); const colorMap = { 'Group Rooms': getCssVariableValue('--doughnut-gd-rooms'), 'Study Carrels': getCssVariableValue('--doughnut-study-carrels'), 'E-Resource': getCssVariableValue('--doughnut-e-resource'), 'Reading Room': getCssVariableValue('--doughnut-reading-room'), }; const backgroundColors = sortedLabels.map(label => colorMap[label] || getCssVariableValue('--doughnut-other')); if (sortedData.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.textAlign = 'center'; ctx.font = '14px Poppins'; ctx.fillStyle = getCssVariableValue('--text-secondary'); ctx.fillText('No occupied seats to display.', ctx.canvas.width / 2, ctx.canvas.height / 2); return; } seatUsageDoughnutChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: sortedLabels, datasets: [{ label: 'Occupied/Reserved Seats', data: sortedData, backgroundColor: backgroundColors, borderColor: getCssVariableValue('--card-bg-color'), borderWidth: 3, hoverOffset: 8, hoverBorderColor: getCssVariableValue('--primary-color'), hoverBorderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: getCssVariableValue('--text-secondary'), padding: 15, font: { size: 11, weight: '500' }, usePointStyle: true, pointStyle: 'rectRounded'} }, tooltip: { backgroundColor: 'rgba(0,0,0,0.75)', titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 12 }, padding: 10, callbacks: { label: (c) => `${c.label || ''}: ${c.parsed || 0} seats` } } }, animation: { animateScale: true, animateRotate: true } } }); }

function updateAnimatedChartNumber(seats) {
    const numberContainer = document.getElementById('animated-chart-number');
    if (!numberContainer) return;
    const totalUsedSeats = seats?.filter(s => s.status === 'occupied' || s.status === 'in-use' || s.status === 'pending-reservation').length || 0;
    const numberString = totalUsedSeats.toString();
    numberContainer.innerHTML = ''; 
    numberContainer.style.width = `${numberString.length * 12 + (numberString.length > 3 ? 7 : 0)}px`;
    numberContainer.classList.toggle('show-comma', numberString.length > 3);
    for (const digit of numberString) {
        const div = document.createElement('div');
        div.innerHTML = `<span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span>`;
        div.style.setProperty('--num', digit);
        div.style.transform = `translateY(calc(-20px * ${digit}))`;
        numberContainer.appendChild(div);
    }
}

function populateActivityTable(tbody, activities) { if (!tbody) return; tbody.innerHTML = ''; if (!activities || activities.length === 0) { const cols = tbody.closest('table')?.querySelector('thead tr')?.children.length || 5; tbody.innerHTML = `<tr><td colspan="${cols}" style="text-align:center;">No activities found.</td></tr>`; return; } activities.forEach(act => { const row = tbody.insertRow(); row.insertCell().textContent = new Date(act.timestamp || act.createdAt).toLocaleString(); row.insertCell().innerHTML = `<span class="user-name-activity">${act.username || act.user?.username || 'System'}</span>`; row.insertCell().textContent = act.action.replace(/_/g, ' '); row.insertCell().textContent = `${act.resourceType || ''} ${act.resourceId || ''}`.trim(); row.insertCell().textContent = act.details || 'N/A'; }); }
document.getElementById('refresh-activities-btn')?.addEventListener('click', loadDashboardData);

async function fetchAndRenderAdminSeats(filter = 'all') { adminSeatMapArea.innerHTML = '<p>Loading seat map...</p>'; const seats = await fetchData(`${API_BASE_URL}/seats`, "Failed to load seat map"); if (seats) { allSeatsDataGlobal = seats; renderAdminSeatMap(seats, filter); updateAdminDashboardStats(seats); initializeSeatUsageDoughnutChart(seats); } else { adminSeatMapArea.innerHTML = '<p>Could not load seat data.</p>'; initializeSeatUsageDoughnutChart([]); } }
function renderAdminSeatMap(seats, filter = 'all') { adminSeatMapArea.innerHTML = ''; const categories = {}; seats.forEach(seat => { if (!categories[seat.category]) { let catName = seat.category.replace(/-/g, ' ').split(' ').map(w => w[0].toUpperCase() + w.slice(1)).join(' '); if (catName === "Gd Rooms") catName = "Group Discussion Rooms"; else if (catName === "EResource") catName = "E-Resource Center"; categories[seat.category] = { name: catName, seats: [] }; } categories[seat.category].seats.push(seat); }); Object.keys(categories).sort().forEach(catKey => { if (filter !== 'all' && filter !== catKey) return; const category = categories[catKey]; const catDiv = document.createElement('div'); catDiv.classList.add('seat-category'); catDiv.dataset.category = catKey; catDiv.innerHTML = `<h3>${category.name}</h3>`; const gridDiv = document.createElement('div'); gridDiv.classList.add('seat-grid', catKey); if (catKey === "gd-rooms") { const rooms = {}; category.seats.forEach(seat => { if(!seat.roomId) { console.warn(`Seat ${seat.seatId} in gd-rooms missing roomId`); return; } if (!rooms[seat.roomId]) { let roomTitleBase = seat.seatId.replace(/-[A-Za-z0-9]+$/, '').replace('GD','').trim(); if (!roomTitleBase) roomTitleBase = seat.roomId; rooms[seat.roomId] = { title: `GD Room ${roomTitleBase}`, subSeats: [] }; } rooms[seat.roomId].subSeats.push(seat); }); Object.keys(rooms).sort().forEach(currentRoomId => { const roomData = rooms[currentRoomId]; const roomCard = document.createElement('div'); roomCard.classList.add('seat-card', 'gd-room'); roomCard.dataset.roomId = currentRoomId; const roomTitleDiv = document.createElement('div'); roomTitleDiv.classList.add('room-title'); roomTitleDiv.textContent = roomData.title; roomCard.appendChild(roomTitleDiv); const subSeatsDiv = document.createElement('div'); subSeatsDiv.classList.add('gd-sub-seats'); roomData.subSeats.sort((a,b) => a.name.localeCompare(b.name)).forEach(subSeat => subSeatsDiv.appendChild(createAdminSeatElement(subSeat, true))); roomCard.appendChild(subSeatsDiv); gridDiv.appendChild(roomCard); }); } else { category.seats.sort((a,b)=>a.name.localeCompare(b.name)).forEach(seat => gridDiv.appendChild(createAdminSeatElement(seat, false))); } catDiv.appendChild(gridDiv); adminSeatMapArea.appendChild(catDiv); }); if (adminSeatMapArea.innerHTML === '') adminSeatMapArea.innerHTML = '<p>No seats match filter or none available.</p>'; }
seatFilterButtons.forEach(button => { button.addEventListener('click', function() { seatFilterButtons.forEach(btn => btn.classList.remove('active')); this.classList.add('active'); renderAdminSeatMap(allSeatsDataGlobal, this.dataset.filter); }); });
function openAdminSeatActionModal(seat) { adminModalTitle.textContent = `Action for Seat: ${seat.name} (${seat.seatId})`; adminModalSeatIdInput.value = seat.seatId; let currentEffectiveStatus = seat.status; if (seat.status === 'pending-reservation' || seat.status === 'in-use') currentEffectiveStatus = 'occupied'; adminSeatStatusSelect.value = currentEffectiveStatus; adminOccupiedByUsernameInput.value = seat.occupiedByUsername || seat.reservedBy?.username || ''; adminOccupiedByContainer.style.display = (adminSeatStatusSelect.value === 'occupied') ? 'block' : 'none'; adminSeatActionModal.style.display = 'flex'; }
adminSeatStatusSelect.addEventListener('change', function() { adminOccupiedByContainer.style.display = (this.value === 'occupied') ? 'block' : 'none'; });
closeModalBtn.addEventListener('click', () => adminSeatActionModal.style.display = 'none');
cancelAdminSeatActionBtn.addEventListener('click', () => adminSeatActionModal.style.display = 'none');
confirmAdminSeatActionBtn.addEventListener('click', async () => { const seatId = adminModalSeatIdInput.value; const newStatus = adminSeatStatusSelect.value; const occupiedBy = newStatus === 'occupied' ? adminOccupiedByUsernameInput.value.trim() : null; confirmAdminSeatActionBtn.disabled = true; confirmAdminSeatActionBtn.textContent = 'Updating...'; const result = await fetchData(`${API_BASE_URL}/seats/${seatId}/status`, "Failed to update seat status", { method: 'PUT', body: { status: newStatus, occupiedByUsername: occupiedBy } }); if (result) { adminSeatActionModal.style.display = 'none'; await fetchAndRenderAdminSeats(document.querySelector('#seats-content .seat-filters .btn-filter.active').dataset.filter); } confirmAdminSeatActionBtn.disabled = false; confirmAdminSeatActionBtn.textContent = 'Confirm'; });
async function fetchAndRenderBooks() { if (!bookCollectionTableBody) { console.error("Book table body not found."); return; } bookCollectionTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading books...</td></tr>'; const booksArray = await fetchData(`${API_BASE_URL}/books`, "Failed to load books"); if (booksArray && Array.isArray(booksArray)) { populateBookTable(booksArray); updateBookStats(booksArray); } else { bookCollectionTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Could not load books.</td></tr>'; updateBookStats([]); } }
function populateBookTable(books) { if (!bookCollectionTableBody) return; bookCollectionTableBody.innerHTML = ''; if (!Array.isArray(books) || books.length === 0) { bookCollectionTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No books found.</td></tr>'; return; } books.forEach(book => { const row = bookCollectionTableBody.insertRow(); row.insertCell().textContent = book.title || 'N/A'; row.insertCell().textContent = book.author || 'N/A'; let statusText = (book.status || 'available').toLowerCase(); const statusCell = row.insertCell(); statusCell.innerHTML = `<span class="status-badge ${statusText.replace(/\s+/g, '-')}">${statusText.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>`; row.insertCell().textContent = book.rack || 'N/A'; row.insertCell().textContent = book.isbn || 'N/A'; const actionsCell = row.insertCell(); const editBtn = document.createElement('button'); editBtn.className = 'btn btn-sm btn-edit'; editBtn.innerHTML = '<i class="fas fa-edit"></i>'; editBtn.onclick = () => openBookModalForEdit(book); const deleteBtn = document.createElement('button'); deleteBtn.className = 'btn btn-sm btn-delete'; deleteBtn.innerHTML = '<i class="fas fa-trash"></i>'; deleteBtn.onclick = () => deleteBook(book._id, book.title); actionsCell.appendChild(editBtn); actionsCell.appendChild(deleteBtn); }); }
function updateBookStats(books) { let total = 0, available = 0, checkedOut = 0, reserved = 0; if (Array.isArray(books)) { total = books.length; available = books.filter(b => (b.status||'available').toLowerCase()==='available').length; checkedOut = books.filter(b => (b.status||'').toLowerCase()==='checked-out').length; reserved = books.filter(b => (b.status||'').toLowerCase()==='reserved').length; } const bookStatsContainer = document.querySelector('#books-content .book-stats'); if (bookStatsContainer) { const totalEl = bookStatsContainer.querySelector('.stat-card:nth-child(1) .stat-value'); const availableEl = bookStatsContainer.querySelector('.stat-card:nth-child(2) .stat-value'); const checkedOutEl = bookStatsContainer.querySelector('.stat-card:nth-child(3) .stat-value'); const reservedEl = bookStatsContainer.querySelector('.stat-card:nth-child(4) .stat-value'); if(totalEl) animateValue(totalEl.firstChild, parseInt(totalEl.firstChild.textContent.replace(/,/g, '')||0), total, 800); if(availableEl) animateValue(availableEl.firstChild, parseInt(availableEl.firstChild.textContent.replace(/,/g, '')||0), available, 800); if(checkedOutEl) animateValue(checkedOutEl.firstChild, parseInt(checkedOutEl.firstChild.textContent.replace(/,/g, '')||0), checkedOut, 800); if(reservedEl) animateValue(reservedEl.firstChild, parseInt(reservedEl.firstChild.textContent.replace(/,/g, '')||0), reserved, 800); } if (dbBooksCheckedOutEl) animateValue(dbBooksCheckedOutEl, parseInt(dbBooksCheckedOutEl.textContent.replace(/,/g, '') || 0), checkedOut, 800); }
function openBookModalForAdd() { bookModalTitle.textContent = 'Add New Book'; bookModalIdInput.value = ''; bookTitleInput.value = ''; bookAuthorInput.value = ''; bookIsbnInput.value = ''; bookStatusSelect.value = 'available'; bookRackInput.value = ''; bookQuantityInput.value = '1'; bookQuantityContainer.style.display = 'block'; bookModal.style.display = 'flex'; }
function openBookModalForEdit(book) { bookModalTitle.textContent = 'Edit Book: ' + book.title; bookModalIdInput.value = book._id; bookTitleInput.value = book.title; bookAuthorInput.value = book.author; bookIsbnInput.value = book.isbn || ''; bookStatusSelect.value = book.status || 'available'; bookRackInput.value = book.rack || ''; bookQuantityContainer.style.display = 'none'; bookModal.style.display = 'flex'; }
addNewBookBtn.addEventListener('click', openBookModalForAdd);
closeBookModalBtn.addEventListener('click', () => bookModal.style.display = 'none');
cancelBookActionBtn.addEventListener('click', () => bookModal.style.display = 'none');
confirmBookActionBtn.addEventListener('click', async () => { const bookId = bookModalIdInput.value; const title = bookTitleInput.value.trim(); const author = bookAuthorInput.value.trim(); const isbn = bookIsbnInput.value.trim(); const status = bookStatusSelect.value; const rack = bookRackInput.value.trim(); const quantity = parseInt(bookQuantityInput.value, 10); if (!title || !author || !rack) { alert('Please fill in Title, Author, and Rack.'); return; } const payload = { title, author, isbn, status, rack }; let url = `${API_BASE_URL}/books`; let method = 'POST'; if (bookId) { url = `${API_BASE_URL}/books/${bookId}`; method = 'PUT'; } else { if (isNaN(quantity) || quantity < 1) { alert('Valid quantity needed for new book(s).'); return; } payload.quantity = quantity; } confirmBookActionBtn.disabled = true; confirmBookActionBtn.textContent = 'Saving...'; const result = await fetchData(url, `Failed to ${bookId ? 'update' : 'add'} book`, { method, body: payload }); if (result) { bookModal.style.display = 'none'; await fetchAndRenderBooks(); if (document.getElementById('dashboard-content').classList.contains('active')) await loadDashboardData(); } confirmBookActionBtn.disabled = false; confirmBookActionBtn.textContent = 'Save Book'; });
async function deleteBook(bookId, bookTitle) { if (!confirm(`Delete "${bookTitle}"? This action cannot be undone.`)) return; const result = await fetchData(`${API_BASE_URL}/books/${bookId}`, "Failed to delete book", { method: 'DELETE' }); if (result) { await fetchAndRenderBooks(); if (document.getElementById('dashboard-content').classList.contains('active')) await loadDashboardData(); } }
async function fetchAllActivities() { const response = await fetchData(`${API_BASE_URL}/activities?limit=100`, "Failed to load all activities"); if (response && response.activities) { populateActivityTable(mainActivityLogTableBody, response.activities); document.getElementById('totalActivitiesStat').innerHTML = `${response.totalActivities || 0} <i class="fas fa-wave-square stat-icon blue"></i>`; const bookActs = response.activities.filter(a => a.resourceType === 'Book').length; const seatActs = response.activities.filter(a => a.resourceType === 'Seat').length; document.getElementById('bookActivitiesStat').innerHTML = `${bookActs} <i class="fas fa-book stat-icon green"></i>`; document.getElementById('seatActivitiesStat').innerHTML = `${seatActs} <i class="fas fa-chair stat-icon blue"></i>`; const usersToday = new Set(response.activities.filter(a => new Date(a.timestamp || a.createdAt).toDateString() === new Date().toDateString() && a.user).map(a => a.user?._id || a.user?.username)).size; document.getElementById('usersActiveTodayStat').innerHTML = `${usersToday} <i class="fas fa-users stat-icon orange"></i>`; } }
function logoutAdmin(message = "You have been logged out.") { if(isScannerActive) stopBarcodeScanner(); alert(message); localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = 'login.html'; }
document.getElementById('admin-logout-btn').addEventListener('click', () => logoutAdmin());

// --- BARCODE SCANNER FUNCTIONS (CHECK-IN & CHECK-OUT) ---

function setupScannerPage() {
    scannerVideo.style.display = 'none';
    scannerPlaceholder.style.display = 'flex';
    if(scannerLog.children.length === 1 && scannerLog.children[0].textContent.includes("No scans yet.")) {
        // Initial state
    }
}

function addToScanLog(message, type = 'info') {
    if (scannerLog.children.length === 1 && scannerLog.children[0].textContent.includes("No scans yet.")) {
        scannerLog.innerHTML = '';
    }
    const li = document.createElement('li');
    const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    li.innerHTML = `<span class="log-msg ${type}">${message}</span> <span class="log-time">${time}</span>`;
    scannerLog.prepend(li);
}

function displayScanResult(message, type = 'info') {
    scanResultDisplay.textContent = message;
    scanResultDisplay.className = type; // 'success', 'error', 'info'
    scanResultDisplay.style.display = 'block';
}

function startBarcodeScanner() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Your browser does not support camera access. Please use a modern browser like Chrome or Firefox.");
        return;
    }
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: scannerVideoContainer,
            constraints: { width: 640, height: 480, facingMode: "environment" }
        },
        decoder: {
            readers: ["code_128_reader", "ean_reader", "upc_reader", "code_39_reader", "codabar_reader"]
        },
        locate: true,
    }, function(err) {
        if (err) {
            console.error(err);
            alert("Error initializing camera. Please ensure you have a webcam connected and have granted permission.");
            return;
        }
        console.log("Initialization finished. Ready to start.");
        Quagga.start();
        isScannerActive = true;
        scannerVideo.style.display = 'block';
        scannerPlaceholder.style.display = 'none';
        toggleScannerBtn.innerHTML = '<i class="fas fa-stop-circle"></i> Stop Camera';
        toggleScannerBtn.classList.remove('btn-primary');
        toggleScannerBtn.classList.add('btn-danger');
        displayScanResult("Scanning... Point camera at a barcode.", 'info');
    });

    Quagga.onProcessed(function(result) {
        const drawingCtx = Quagga.canvas.ctx.overlay;
        const drawingCanvas = Quagga.canvas.dom.overlay;
        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
        if (result && result.box) {
            Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "green", lineWidth: 2 });
        }
    });

    Quagga.onDetected(handleBarcodeDetected);
}

function stopBarcodeScanner() {
    if (isScannerActive) {
        Quagga.stop();
        Quagga.offDetected(handleBarcodeDetected);
        Quagga.offProcessed();
        isScannerActive = false;
        scannerVideo.style.display = 'none';
        scannerPlaceholder.style.display = 'flex';
        toggleScannerBtn.innerHTML = '<i class="fas fa-video"></i> Start Camera';
        toggleScannerBtn.classList.remove('btn-danger');
        toggleScannerBtn.classList.add('btn-primary');
        scanResultDisplay.style.display = 'none';
    }
}

async function handleBarcodeDetected(result) {
    Quagga.pause();
    const scannedUsername = result.codeResult.code;

    // First, check if the user is already checked in (for CHECK-OUT)
    const checkedInSeat = allSeatsDataGlobal.find(s =>
        (s.status === 'occupied' || s.status === 'in-use') && s.occupiedByUsername === scannedUsername
    );

    if (checkedInSeat) {
        // --- ACTION: CHECK-OUT ---
        displayScanResult(`Checking OUT ${scannedUsername} from seat ${checkedInSeat.name}...`, 'info');
        const updateResult = await fetchData(`${API_BASE_URL}/seats/${checkedInSeat.seatId}/status`, `Failed to check-out ${scannedUsername}`, {
            method: 'PUT',
            body: { status: 'available' }
        });

        if (updateResult) {
            const successMsg = `CHECK-OUT: ${scannedUsername} from seat ${checkedInSeat.name}.`;
            displayScanResult(successMsg, 'success');
            addToScanLog(successMsg, 'success');
        } else {
            const errorMsg = `ERROR: Failed to check-out ${scannedUsername}.`;
            displayScanResult(errorMsg, 'error');
            addToScanLog(errorMsg, 'error');
        }
    } else {
        // --- ACTION: CHECK-IN ---
        // If not checked in, check for a reservation
        const reservation = allSeatsDataGlobal.find(s => 
            s.status === 'pending-reservation' && s.reservedBy?.username === scannedUsername
        );

        if (reservation) {
            // --- SCENARIO: Reserved Check-in ---
            displayScanResult(`Checking IN ${scannedUsername} to reserved seat ${reservation.name}...`, 'info');
            const updateResult = await fetchData(`${API_BASE_URL}/seats/${reservation.seatId}/status`, `Failed to check-in ${scannedUsername}`, {
                method: 'PUT',
                body: { status: 'occupied', occupiedByUsername: scannedUsername }
            });

            if (updateResult) {
                const successMsg = `CHECK-IN: ${scannedUsername} to reserved seat ${reservation.name}.`;
                displayScanResult(successMsg, 'success');
                addToScanLog(successMsg, 'success');
            } else {
                const errorMsg = `ERROR: Failed to check-in ${scannedUsername} to reserved seat.`;
                displayScanResult(errorMsg, 'error');
                addToScanLog(errorMsg, 'error');
            }
        } else {
            // --- SCENARIO: Walk-in Check-in ---
            const infoMsg = `MANUALY ENTER: User ${scannedUsername} entered. Please assign a seat manually.`;
            displayScanResult(infoMsg, 'info');
            addToScanLog(infoMsg, 'info');
        }
    }

    // After ANY action, refresh all data to ensure the next scan is accurate.
    await loadDashboardData();
    if(document.getElementById('seats-content').classList.contains('active')) {
        fetchAndRenderAdminSeats('all');
    }

    // Resume scanning after a 3-second cooldown
    setTimeout(() => {
        if(isScannerActive) {
            Quagga.start();
            displayScanResult("Scanning... Point camera at a barcode.", 'info');
        }
    }, 3000);
}

if(toggleScannerBtn) {
    toggleScannerBtn.addEventListener('click', () => {
        if (isScannerActive) {
            stopBarcodeScanner();
        } else {
            startBarcodeScanner();
        }
    });
}

document.getElementById('exportLogsBtn')?.addEventListener('click', () => alert("Export logs functionality not implemented yet."));

// --- Initial Load ---
const activeDefaultLink = document.querySelector('.sidebar .nav-link.active');
if (activeDefaultLink) {
    const target = activeDefaultLink.dataset.target;
    if (target === 'dashboard') loadDashboardData();
    else if (target === 'seats') fetchAndRenderAdminSeats('all');
    else if (target === 'seminarseats') loadAndRenderSeminarRooms();
    else if (target === 'books') fetchAndRenderBooks();
    else if (target === 'activities') fetchAllActivities();
    else if (target === 'scanner') setupScannerPage();
} else { loadDashboardData(); }
});
</script>
</body>
</html>